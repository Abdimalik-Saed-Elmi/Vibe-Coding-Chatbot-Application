<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
    </style>
  </head>
  <body class="bg-white h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="w-full border-b border-gray-200 bg-white">
      <div
        class="max-w-full mx-auto px-4 py-3 flex items-center justify-between"
      >
        <!-- Left: ChatGPT with dropdown -->
        <div
          class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity"
        >
          <h1 class="text-xl font-semibold text-gray-900">ChatGPT</h1>
          <svg
            class="w-4 h-4 text-gray-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </div>

        <!-- Center: Upgrade button -->
        <div class="flex-1 flex justify-center">
          <button
            class="px-4 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-full flex items-center space-x-1.5 transition-colors"
          >
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
              ></path>
            </svg>
            <span>Upgrade to Go</span>
          </button>
        </div>

        <!-- Right: Profile and settings icons -->
        <div class="flex items-center space-x-3">
          <button
            class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center transition-colors cursor-pointer"
            aria-label="Profile"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
          <button
            class="w-8 h-8 rounded-md border border-gray-300 hover:bg-gray-50 flex items-center justify-center transition-colors cursor-pointer"
            aria-label="Settings"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col px-4 py-8 overflow-y-auto min-h-0">
      <div class="w-full max-w-3xl mx-auto">
        <!-- Welcome message (shown when no messages) -->
        <div id="welcome-message" class="text-center">
          <h2 class="text-3xl md:text-4xl font-normal text-gray-900 mb-8">
            What's on the agenda today?
          </h2>
        </div>

        <!-- Chat messages container -->
        <div id="chat-messages" class="space-y-6 hidden"></div>
      </div>
    </main>

    <!-- Input Area -->
    <div class="w-full border-t border-gray-200 bg-white pb-6 pt-4">
      <div class="max-w-3xl mx-auto px-4">
        <div class="relative flex items-center">
          <!-- Plus button on left -->
          <button
            class="absolute left-2 w-8 h-8 rounded-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center transition-colors z-10"
            aria-label="New chat"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              ></path>
            </svg>
          </button>

          <!-- Input field -->
          <div class="relative flex-1 ml-12 mr-2">
            <input
              type="text"
              placeholder="Ask anything"
              class="w-full pl-10 pr-24 py-4 border border-gray-300 rounded-3xl bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all text-base shadow-sm"
            />

            <!-- Small green robot icon inside input -->
            <div class="absolute left-3 bottom-1/2 transform translate-y-1/2">
              <div
                class="w-5 h-5 bg-green-600 rounded flex items-center justify-center"
              >
                <svg
                  class="w-3.5 h-3.5 text-white"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
            </div>

            <!-- Right side icons -->
            <div
              class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2"
            >
              <!-- Send button -->
              <button
                class="w-7 h-7 flex items-center justify-center hover:bg-gray-100 rounded-md transition-colors"
                aria-label="Send message"
              >
                <svg
                  class="w-5 h-5 text-gray-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                  ></path>
                </svg>
              </button>

              <!-- Green robot icon -->
              <button
                class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-md transition-colors"
                aria-label="AI mode"
              >
                <div
                  class="w-6 h-6 bg-green-600 rounded flex items-center justify-center"
                >
                  <svg
                    class="w-4 h-4 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
              </button>

              <!-- Microphone icon -->
              <button
                class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-md transition-colors"
                aria-label="Voice input"
              >
                <svg
                  class="w-5 h-5 text-gray-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                  ></path>
                </svg>
              </button>

              <!-- Audio waveform button -->
              <button
                class="w-8 h-8 bg-black hover:bg-gray-800 rounded-full flex items-center justify-center transition-colors"
                aria-label="Voice recording"
              >
                <div class="flex items-center space-x-0.5">
                  <div class="w-0.5 h-3 bg-white rounded-full"></div>
                  <div class="w-0.5 h-4 bg-white rounded-full"></div>
                  <div class="w-0.5 h-2 bg-white rounded-full"></div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API Configuration
      const OLLAMA_URL = "http://localhost:11434/api/generate";
      const MODEL = "deepseek-r1:1.5b";

      // DOM Elements
      const input = document.querySelector('input[type="text"]');
      const sendButton = document.querySelector(
        'button[aria-label="Send message"]'
      );
      const chatMessages = document.getElementById("chat-messages");
      const welcomeMessage = document.getElementById("welcome-message");

      /**
       * Detects if we're running from file:// protocol
       * @returns {boolean} True if running from file://
       */
      function isFileProtocol() {
        return window.location.protocol === "file:";
      }

      /**
       * Sends a message to the Ollama API and returns the response
       * @param {string} prompt - The user's question/prompt
       * @returns {Promise<Object>} The API response
       */
      async function sendMessageToAPI(prompt) {
        try {
          const requestBody = JSON.stringify({
            model: MODEL,
            prompt: prompt,
            stream: false,
          });

          const response = await fetch(OLLAMA_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: requestBody,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          // Check if it's a CORS error
          const isCorsError =
            error.message.includes("Failed to fetch") ||
            error.message.includes("CORS") ||
            error.name === "TypeError" ||
            (error.message && error.message.includes("blocked"));

          if (isCorsError) {
            const isFile = isFileProtocol();
            let errorMsg = "‚ùå CORS Error: Browser blocked the request.\n\n";

            if (isFile) {
              errorMsg += "You're opening this file directly (file://).\n\n";
            }

            errorMsg += "üîß Quick Solutions:\n\n";
            errorMsg +=
              "1Ô∏è‚É£ Install the bundled 'Ollama CORS Helper' browser extension (pure JavaScript).\n";
            errorMsg +=
              "   - Load it as an unpacked extension from the project folder\n";
            errorMsg += "   - Enable 'Allow access to file URLs'\n\n";

            errorMsg += "2Ô∏è‚É£ Chrome with CORS disabled (Dev only):\n";
            errorMsg += "   Launch Chrome with --disable-web-security flag\n\n";

            errorMsg += "3Ô∏è‚É£ Simple HTTP Server:\n";
            errorMsg +=
              "   Serve this folder (php -S localhost:8000) and open via http://localhost\n\n";

            errorMsg +=
              "üí° Click 'View Solutions' below for setup instructions.";

            throw new Error(errorMsg);
          }

          // Re-throw other errors
          throw error;
        }
      }

      /**
       * Adds a user message to the chat UI
       * @param {string} message - The user's message
       */
      function addUserMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex justify-end";
        messageDiv.innerHTML = `
          <div class="max-w-[80%] bg-purple-600 text-white rounded-2xl px-4 py-3 shadow-sm">
            <p class="text-sm whitespace-pre-wrap">${escapeHtml(message)}</p>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      /**
       * Adds an AI response to the chat UI
       * @param {string} response - The AI's response text
       */
      function addAIResponse(response) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex justify-start";
        messageDiv.innerHTML = `
          <div class="max-w-[80%] bg-gray-100 text-gray-900 rounded-2xl px-4 py-3 shadow-sm">
            <p class="text-sm whitespace-pre-wrap">${escapeHtml(response)}</p>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      /**
       * Shows a loading indicator while waiting for AI response
       */
      function showLoadingIndicator() {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex justify-start";
        messageDiv.id = "loading-indicator";
        messageDiv.innerHTML = `
          <div class="max-w-[80%] bg-gray-100 text-gray-900 rounded-2xl px-4 py-3 shadow-sm">
            <div class="flex items-center space-x-2">
              <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
              </div>
            </div>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      /**
       * Removes the loading indicator
       */
      function removeLoadingIndicator() {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          loadingIndicator.remove();
        }
      }

      /**
       * Shows an error message in the chat
       * @param {string} error - The error message
       */
      function showError(error) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "flex justify-start";
        messageDiv.innerHTML = `
          <div class="max-w-[80%] bg-red-50 border border-red-200 text-red-800 rounded-2xl px-4 py-3 shadow-sm">
            <p class="text-sm">Error: ${escapeHtml(error)}</p>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      /**
       * Escapes HTML to prevent XSS attacks
       * @param {string} text - Text to escape
       * @returns {string} Escaped HTML
       */
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      /**
       * Scrolls the chat to the bottom
       */
      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      /**
       * Handles sending a message
       * @param {string} message - The user's message
       */
      async function handleSendMessage(message) {
        if (!message.trim()) return;

        // Hide welcome message and show chat messages
        welcomeMessage.classList.add("hidden");
        chatMessages.classList.remove("hidden");

        // Add user message to UI
        addUserMessage(message);

        // Clear input
        input.value = "";
        input.disabled = true;
        sendButton.disabled = true;

        // Show loading indicator
        showLoadingIndicator();

        try {
          // Send message to API
          const response = await sendMessageToAPI(message);

          // Remove loading indicator
          removeLoadingIndicator();

          // Add AI response to UI
          if (response.response) {
            addAIResponse(response.response);
          } else {
            showError("No response received from API");
          }
        } catch (error) {
          // Remove loading indicator
          removeLoadingIndicator();

          // Show error message with helpful CORS solutions
          let errorMessage =
            error.message ||
            "Failed to get response. Make sure Ollama is running on localhost:11434";

          // Format CORS error message for better display
          if (errorMessage.includes("CORS Error")) {
            errorMessage = errorMessage.replace(/\n/g, "<br>");
            const errorDiv = document.createElement("div");
            errorDiv.className = "flex justify-start";
            errorDiv.innerHTML = `
              <div class="max-w-[80%] bg-red-50 border border-red-200 text-red-800 rounded-2xl px-4 py-3 shadow-sm">
                <p class="text-sm font-semibold mb-2">‚ö†Ô∏è CORS Error Detected</p>
                <div class="text-sm whitespace-pre-line">${errorMessage}</div>
                <button onclick="window.open('quick-start.html', '_blank')" 
                        class="mt-3 text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                  üìñ View Quick Start Guide
                </button>
              </div>
            `;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
          } else {
            showError(errorMessage);
          }
        } finally {
          // Re-enable input and button
          input.disabled = false;
          sendButton.disabled = false;
          input.focus();
        }
      }

      /**
       * Tests the connection to Ollama API on page load
       */
      async function testConnection() {
        // Only show warning if using file:// protocol
        if (isFileProtocol()) {
          const warningDiv = document.createElement("div");
          warningDiv.className =
            "fixed top-20 left-1/2 transform -translate-x-1/2 bg-yellow-50 border border-yellow-200 rounded-lg p-4 shadow-lg max-w-md z-50";
          warningDiv.innerHTML = `
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="ml-3 flex-1">
                <h3 class="text-sm font-medium text-yellow-800">CORS Warning</h3>
                <p class="mt-1 text-sm text-yellow-700">
                  Opening via file:// may cause CORS errors. 
                  <a href="quick-start.html" target="_blank" class="underline font-semibold">View quick start guide</a>
                </p>
              </div>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-yellow-400 hover:text-yellow-600">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
          `;
          document.body.appendChild(warningDiv);

          // Auto-remove after 10 seconds
          setTimeout(() => {
            if (warningDiv.parentElement) {
              warningDiv.remove();
            }
          }, 10000);
        }
      }

      // Test connection on page load
      testConnection();

      // Event Listeners
      // Enter key to send message
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey && this.value.trim()) {
          e.preventDefault();
          handleSendMessage(this.value);
        }
      });

      // Send button click
      sendButton.addEventListener("click", function () {
        if (input.value.trim()) {
          handleSendMessage(input.value);
        }
      });

      // New chat button
      document
        .querySelector('button[aria-label="New chat"]')
        .addEventListener("click", function () {
          chatMessages.innerHTML = "";
          chatMessages.classList.add("hidden");
          welcomeMessage.classList.remove("hidden");
          input.value = "";
          input.focus();
        });
    </script>
  </body>
</html>
